use std::net::UdpSocket;
use std::thread;
use std::time::Duration;

use a2s_query::A2S;
use a2s_query::players::{Player, TheShipInfo};
#[test]
fn test_players_counter_strike_source() {
    let test_info = &[
        0xFF, 0xFF, 0xFF, 0xFF, 0x49, 0x02, 0x67, 0x61, 0x6D, 0x65, 0x32, 0x78, 0x73, 0x2E, 0x63,
        0x6F, 0x6D, 0x20, 0x43, 0x6F, 0x75, 0x6E, 0x74, 0x65, 0x72, 0x2D, 0x53, 0x74, 0x72, 0x69,
        0x6B, 0x65, 0x20, 0x53, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x20, 0x23, 0x31, 0x00, 0x64, 0x65,
        0x5F, 0x64, 0x75, 0x73, 0x74, 0x00, 0x63, 0x73, 0x74, 0x72, 0x69, 0x6B, 0x65, 0x00, 0x43,
        0x6F, 0x75, 0x6E, 0x74, 0x65, 0x72, 0x2D, 0x53, 0x74, 0x72, 0x69, 0x6B, 0x65, 0x3A, 0x20,
        0x53, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x00, 0xF0, 0x00, 0x05, 0x10, 0x04, 0x64, 0x6C, 0x00,
        0x00, 0x31, 0x2E, 0x30, 0x2E, 0x30, 0x2E, 0x32, 0x32, 0x00,
    ];
    let test_data = &[
        0xFF, 0xFF, 0xFF, 0xFF, 0x44, 0x02, 0x01, 0x5B, 0x44, 0x5D, 0x2D, 0x2D, 0x2D, 0x2D, 0x3E,
        0x54, 0x2E, 0x4E, 0x2E, 0x57, 0x3C, 0x2D, 0x2D, 0x2D, 0x2D, 0x00, 0x0E, 0x00, 0x00, 0x00,
        0xB4, 0x97, 0x00, 0x44, 0x02, 0x4B, 0x69, 0x6C, 0x6C, 0x65, 0x72, 0x20, 0x21, 0x21, 0x21,
        0x00, 0x05, 0x00, 0x00, 0x00, 0x69, 0x24, 0xD9, 0x43,
    ];
    let expected_players = vec![
        Player {
            index: 1,
            name: "[D]---->T.N.W<----".to_string(),
            score: 14,
            duration: 514.37036,
            the_ship: None,
        },
        Player {
            index: 2,
            name: "Killer !!!".to_string(),
            score: 5,
            duration: 434.28445,
            the_ship: None,
        },
    ];
    test_data_players(test_info, test_data, &expected_players);
}

#[test]
fn test_players_the_ship() {
    let test_info = &[
        0xFF, 0xFF, 0xFF, 0xFF, 0x49, 0x07, 0x53, 0x68, 0x69, 0x70, 0x20, 0x53, 0x65, 0x72, 0x76,
        0x65, 0x72, 0x00, 0x62, 0x61, 0x74, 0x61, 0x76, 0x69, 0x65, 0x72, 0x00, 0x73, 0x68, 0x69,
        0x70, 0x00, 0x54, 0x68, 0x65, 0x20, 0x53, 0x68, 0x69, 0x70, 0x00, 0x60, 0x09, 0x01, 0x05,
        0x00, 0x6C, 0x77, 0x00, 0x00, 0x01, 0x03, 0x03, 0x31, 0x2E, 0x30, 0x2E, 0x30, 0x2E, 0x34,
        0x00,
    ];
    let test_data = &[
        0xFF, 0xFF, 0xFF, 0xFF, 0x44, 0x13, 0x00, 0x53, 0x68, 0x69, 0x70, 0x6D, 0x61, 0x74, 0x65,
        0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xBF, 0x01, 0x53, 0x68, 0x69, 0x70,
        0x6D, 0x61, 0x74, 0x65, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xBF, 0x02,
        0x53, 0x68, 0x69, 0x70, 0x6D, 0x61, 0x74, 0x65, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x80, 0xBF, 0x03, 0x53, 0x68, 0x69, 0x70, 0x6D, 0x61, 0x74, 0x65, 0x34, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xBF, 0x04, 0x53, 0x68, 0x69, 0x70, 0x6D, 0x61, 0x74,
        0x65, 0x35, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xBF, 0x07, 0x28, 0x31, 0x29,
        0x4C, 0x61, 0x6E, 0x64, 0x4C, 0x75, 0x62, 0x62, 0x65, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xD3, 0x8E, 0x68, 0x45, 0x00, 0x00, 0x00, 0x00, 0xC4, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xC4, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC4, 0x09, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xC4, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC4, 0x09, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xC4, 0x09, 0x00, 0x00,
    ];
    let expected_players = vec![
        Player {
            index: 0,
            name: "Shipmate1".to_string(),
            score: 0,
            duration: -1.0,
            the_ship: Some(TheShipInfo {
                deaths: 1768444673,
                money: 1952542064,
            }),
        },
        Player {
            index: 101,
            name: "2".to_string(),
            score: 0,
            duration: -1.0,
            the_ship: Some(TheShipInfo {
                deaths: 1768444674,
                money: 1952542064,
            }),
        },
        Player {
            index: 101,
            name: "3".to_string(),
            score: 0,
            duration: -1.0,
            the_ship: Some(TheShipInfo {
                deaths: 1768444675,
                money: 1952542064,
            }),
        },
        Player {
            index: 101,
            name: "4".to_string(),
            score: 0,
            duration: -1.0,
            the_ship: Some(TheShipInfo {
                deaths: 1768444676,
                money: 1952542064,
            }),
        },
        Player {
            index: 101,
            name: "5".to_string(),
            score: 0,
            duration: -1.0,
            the_ship: Some(TheShipInfo {
                deaths: 691087367,
                money: 1684955468,
            }),
        },
        Player {
            index: 76,
            name: "ubber".to_string(),
            score: 0,
            duration: 3720.9265,
            the_ship: Some(TheShipInfo {
                deaths: 0,
                money: 2500,
            }),
        },
        Player {
            index: 0,
            name: "".to_string(),
            score: 163840000,
            duration: 0.0,
            the_ship: Some(TheShipInfo {
                deaths: 163840000,
                money: 0,
            }),
        },
        Player {
            index: 0,
            name: "".to_string(),
            score: 2500,
            duration: 0.0,
            the_ship: Some(TheShipInfo {
                deaths: 2500,
                money: 0,
            }),
        },
    ];
    test_data_players(test_info, test_data, &expected_players);
}

fn test_data_players(
    info: &'static [u8],
    response_data: &'static [u8],
    expected_players: &Vec<Player>,
) {
    let server_socket = UdpSocket::bind("127.0.0.1:0").expect("Failed to bind server socket");
    server_socket
        .set_read_timeout(Some(std::time::Duration::from_secs(5)))
        .expect("Failed to set read timeout");
    let server_addr = server_socket
        .local_addr()
        .expect("Failed to get local address");

    let server_handle = thread::spawn(move || {
        let mut buf = [0u8; 25];

        let (_, client_addr) = server_socket
            .recv_from(&mut buf)
            .expect("Failed to receive info request");
        server_socket
            .send_to(&info, client_addr)
            .expect("Failed to send info response");

        let (_, client_addr) = server_socket
            .recv_from(&mut buf)
            .expect("Failed to receive players request");
        server_socket
            .send_to(&response_data, client_addr)
            .expect("Failed to send player response");
    });

    thread::sleep(Duration::from_millis(10));

    let a2s = A2S::new(server_addr);

    let players = a2s.players().expect("Failed to get players");
    assert_eq!(players, *expected_players);

    server_handle.join().expect("Server thread panicked");
}
